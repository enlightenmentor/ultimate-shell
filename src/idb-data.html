<script src="../bower_components/idb-promised/lib/idb.js"></script>

<dom-module id="idb-data">
  <script>
    class IDBData extends Polymer.Element {

      static get is() {
        return "idb-data";
      }

      static get properties() {
        return {
          key: String,
          _dbKey: {
            type: String,
            computed: "_makeDBKey(key)"
          },
          _storeKey: {
            type: String,
            computed: "_makeStoreKey(key)"
          },
          // data: Object,
          storedData: Object,
          dbPromise: Object
        }
      }

      _makeDBKey(key) {
        return `${this.key}-db`;
      }

      _makeStoreKey(key) {
        return `${this.key}-store`;
      }

      connectedCallback() {
        super.connectedCallback();
        this._establishConnection();
      }

      _establishConnection() {
        this.dbPromise = idb.open(this._dbKey, 1, upgradeDB => {
          upgradeDB.createObjectStore(this._storeKey);
        });
        console.log(`<idb-data id='${this.id}'>: connect`, window.performance.now());
      }

      async read() {
        const db = await this.dbPromise;
        const transaction = db.transaction(this._storeKey);
        let value = await transaction.objectStore(this._storeKey).get(this.key);
        if (!value)
          value = null;
        this.set("storedData", value);
        console.log(`<idb-data id='${this.id}'>: read`, window.performance.now());
        return value;
      }

      write(data) {
        if (data && this.key && this.dbPromise && this.storedData !== undefined) {
          const changes = Tools.filterDeep(data, this.storedData);
          if (changes) {
            this.dbPromise.then(db => {
              const transaction = db.transaction(this._storeKey, 'readwrite');
              transaction.objectStore(this._storeKey).put(data, this.key);
              return transaction.complete;
            }).then(() => {
              this.set("storedData", Object.assign({}, data)); // Mutable DANGER!!! should be immutable
              console.log(`<idb-data id='${this.id}'>: write`, window.performance.now());
            });
          }
        }
      }

      fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {
          composed: true,
          bubbles: true,
          detail: detail
        }));
      }
    }
    customElements.define(IDBData.is, IDBData);
  </script>
</dom-module>