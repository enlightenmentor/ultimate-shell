<dom-module id="fire-data">
  <script>
    class FireData extends Polymer.Element {

      static get is() {
        return "fire-data";
      }

      static get properties() {
        return {
          path: String,
          active: {
            type: Boolean,
            value: true
          },
          _listenCallback: Function
        }
      }

      read() {
        return new Promise((resolve, reject) => {
          const ref = firebase.database().ref(this.path);
          ref.once('value', (snapshot) => {
            return resolve(snapshot.val());
          });
        });
      }

      write(data) {
        if (data && this.path && this.active) {
          const ref = firebase.database().ref(this.path);
          ref.update(data);
        }
      }

      listen(callback) {
        this._listenCallback = (snapshot) => {
          if (snapshot.exists())
            return callback(snapshot.val());
        };
        const ref = firebase.database().ref(this.path);
        ref.on('value', this._listenCallback);
      }

      stopListen() {
        if (this._listenCallback) {
          const ref = firebase.database().ref(this.path);
          ref.off('value', this._listenCallback);
          this._listenCallback = null;
        }
      }

      setPath(path) {
        this.path = path;
      }

      activate() {
        this.active = true;
      }

      deactivate() {
        this.active = false;
      }

      fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {
          composed: true,
          bubbles: true,
          detail: detail
        }));
      }
    }
    customElements.define(FireData.is, FireData);
  </script>
</dom-module>