<dom-module id="fire-data">
  <script>
    class FireData extends Polymer.Element {

      static get is() {
        return "fire-data";
      }

      static get properties() {
        return {
          // data: Object,
          serverData: Object,
          path: String,
          _ref: {
            type: Object,
            computed: "_establishConnection(path)",
            // observer: "read"
          },
        }
      }

      _establishConnection(path) {
        let ref;
        if (path) {
          ref = firebase.database().ref(path);
          ref.on("value", (snapshot) => this._update(snapshot));
          console.log(`<fire-data id='${this.id}'>: connect`, window.performance.now());
        } else {
          ref = null;
          console.log(`<fire-data id='${this.id}'>: disconnect`, window.performance.now());
        }
        return ref;
      }

      async read() {
        if (!this._ref)
          return;
        if (this.serverData)
          return this.serverData;
        return new Promise((resolve, reject) => {
          const callback = (snapshot) => {
            this._ref.off("value", callback);
            console.log(`<fire-data id='${this.id}'>: read`, window.performance.now());
            this.set("serverData", snapshot.val());
            return resolve(snapshot.val());
          };
          this._ref.on("value", callback);
        });
      }

      write(data) {
        if (data && this.serverData !== undefined && this._ref) {
          var changes = Tools.filterDeep(data, this.serverData);
          if (changes) {
            console.log(`<fire-data id='${this.id}'>: write`, window.performance.now());
            this._ref.update(changes);
          }
        }
      }

      _update(snapshot) {
        console.log(`<fire-data id='${this.id}'>: update`, window.performance.now());
        this.set("serverData", snapshot.val());
        this.fire("new-firedata", snapshot.val());
      }

      fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {
          composed: true,
          bubbles: true,
          detail: detail
        }));
      }
    }
    customElements.define(FireData.is, FireData);
  </script>
</dom-module>