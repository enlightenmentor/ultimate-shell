<link rel="import" href="../bower_components/iron-location/iron-location.html">

<dom-module id="app-router">
  <template>
    <iron-location id="ironLocation" path="{{_path}}" query="{{_query}}" hash="{{_hash}}"></iron-location>
  </template>
  <script>
    class AppRouter extends Polymer.Element {

      static get is() {
        return "app-router";
      }

      static get properties() {
        return {
          defaultUrl: String,
          route: {
            type: Object,
            notify: true,
            observer: '_routeChanged'
          }
        }
      }

      static get observers() {
        return ["_pathChanged(defaultUrl, _path, _query, _hash)"];
      }

      _pathChanged(defaultUrl) {
        if (location.pathname === "/" && defaultUrl)
          this.setUrl(`/${defaultUrl}`);
        if (!this.route)
          this.set('route', AppRouter.parseUrl(location));
        else if (this.route.url !== location.pathname)
          this.set('route', AppRouter.parseUrl(location));
      }

      setUrl(url) {
        if (AppRouter.parseUrl(location).url !== url) {
          history.pushState({}, null, url);
          this.set('route', AppRouter.parseUrl(location));
        }
      }

      getUrl() {
        AppRouter.parseUrl(location);
      }

      _routeChanged(route) {
        this.fire('state-change-route', route);
      }

      fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {composed: true, bubbles: true, detail: detail}));
      }

      static parseUrl(location) {
        let res = {
          path: location.pathname.substr(1),
          search: location.search.substr(1),
          hash: location.hash.substr(1),
          url: AppRouter.pathSearchHashToURL(location.pathname, location.search, location.hash)
        };
        if (res.path)
          res.segments = res.path.split("/").filter(item => item !== "");
        if (res.search) {
          res.queries = {};
          res.search.split("&").map(function (q) {
            let pair = q.split("=");
            res.queries[pair[0]] = pair[1];
          });
        }
        return res;
      }

      static pathSearchHashToURL(path, search, hash) {
        return (path || "") + (search || "") + (hash || "");
      }
    }
    customElements.define(AppRouter.is, AppRouter);
  </script>
</dom-module>