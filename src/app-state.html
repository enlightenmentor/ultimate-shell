<script src="js/tools.js"></script>

<dom-module id="app-state">
  <script>
    class AppState extends Polymer.Element {
      static get is() {
        return "app-state";
      }

      static get properties() {
        return {
          state: {
            type: Object,
            notify: true,
            observer: '_storeState'
          },
          initialState: {
            type: Object,
            value: () => ({
              settings: {
                checkbox: true,
                radio: "first",
                slider: 0,
                toggler: false,
                dropdown: 0
              }
            })
          }
        }
      }

      connectedCallback() {
        super.connectedCallback();

        window.addEventListener('state-action', (e) => {
          this.set('state', this.stateReducer(this.state, e.detail));
        });

        window.addEventListener('app-connected', (e) => {
          this.set('state', this.stateReducer(this.state));
        })
      }

      stateReducer(state, action) {
        if (!state) {
          const storedState = this._getState();
          if (storedState)
            state = Object.assign({}, state, storedState);
          else
            state = Object.assign({}, state, this.initialState);
        }

        if (action) {
          console.log(action.type, performance.now());
          switch (action.type) {
            case 'USER_IN': {
              let user = action.payload;
              state = Object.assign({}, state, {
                user: user
              });
              break;
            }
            case 'USER_OUT': {
              state = Object.assign({}, state, {
                user: null
              });
              break;
            }
            case 'SETTINGS_CHANGE': {
              let prop = action.payload;
              let settings = Object.assign({}, state.settings, {
                [prop.key]: prop.value
              });

              state = Object.assign({}, state, {
                settings: settings
              });
              break;
            }
            case 'SERVER_ALBUMS': {
              let albums = action.payload;
              state = Object.assign({}, state, {
                albums: albums
              });
              break;
            }
            case 'SERVER_SETTINGS': {
              let settings = action.payload;
              if (settings) {
                state = Object.assign({}, state, {
                  settings: settings
                });
              }
              break;
            }
          }
        }
        return Tools.deepFreeze(state);
      }

      _storeState(state) {
        localStorage.setItem('state', JSON.stringify(state));
      }

      _getState() {
        return JSON.parse(localStorage.getItem('state'));
      }

      fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {
          composed: true,
          bubbles: true,
          detail: detail
        }))
      }
    }
    customElements.define(AppState.is, AppState);
  </script>
</dom-module>