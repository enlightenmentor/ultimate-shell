<script src="js/tools.js"></script>

<dom-module id="app-state">
  <script>
    class AppState extends Polymer.Element {
      static get is() {
        return "app-state";
      }

      static get properties() {
        return {
          state: {
            type: Object,
            notify: true,
            observer: '_storeState'
          },
          initialState: {
            type: Object,
            value: () => ({
              settings: {
                checkbox: true,
                radio: "first",
                slider: 0,
                toggler: false,
                dropdown: 0
              }
            })
          }
        }
      }

      connectedCallback() {
        super.connectedCallback();

        const listen = (name, callback) => {
          window.addEventListener(name, callback);
        }

        listen('app-connected', (e) => {
          let state;
          if (!this.state) {
            const storedState = this._getState();
            if (storedState)
              state = Object.assign({}, this.state, storedState);
            else
              state = Object.assign({}, this.state, this.initialState);
          }
          this.set('state', Tools.deepFreeze(state));
        });

        listen('state-user-in', (e) => {
          const user = e.detail;
          const state = Object.assign({}, this.state, {
            user: user
          });
          this.set('state', Tools.deepFreeze(state));
        });

        listen('state-user-out', (e) => {
          const state = Object.assign({}, this.state, {
            user: null
          });
          this.set('state', Tools.deepFreeze(state));
        });

        listen('state-server-albums', (e) => {
          const albums = e.detail;
          const state = Object.assign({}, this.state, {
            albums: albums
          });
          this.set('state', Tools.deepFreeze(state));
        });

        listen('state-server-settings', (e) => {
          const settings = e.detail;
          if (settings) {
            const state = Object.assign({}, this.state, {
              settings: settings
            });
            this.set('state', Tools.deepFreeze(state));
          }
        });

        listen('state-change-settings', (e) => {
          const prop = e.detail;
          const settings = Object.assign({}, this.state.settings, {
            [prop.key]: prop.value
          });
          const state = Object.assign({}, this.state, {
            settings: settings
          });
          this.set('state', Tools.deepFreeze(state));
        });
      }

      _storeState(state) {
        localStorage.setItem('state', JSON.stringify(state));
      }

      _getState() {
        return JSON.parse(localStorage.getItem('state'));
      }

      fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {
          composed: true,
          bubbles: true,
          detail: detail
        }))
      }
    }
    customElements.define(AppState.is, AppState);
  </script>
</dom-module>