<script src="js/tools.js"></script>

<dom-module id="app-state">
  <template>
    <app-history id="history" history="{{history}}"></app-history>
  </template>
  <script>
    class StateHistory extends Array {
      constructor() {
        super();
      }
      newSnapshot(snapshot) {
        this.push(snapshot);
      }
    }
    
    class AppState extends Polymer.Element {
      static get is() {
        return "app-state";
      }

      static get properties() {
        return {
          state: {
            type: Object,
            notify: true,
            observer: '_storeState'
          },
          initialState: {
            type: Object,
            value: () => ({
              settings: {
                checkbox: true,
                radio: "first",
                slider: 0,
                toggler: false,
                dropdown: 0
              }
            })
          },
          history: {
            type: StateHistory,
            notify: true,
            value: () => new StateHistory()
          }
        }
      }

      connectedCallback() {
        super.connectedCallback();

        const listen = (name, callback) => {
          window.addEventListener(name, callback);
        }

        listen('app-connected', (e) => {
          console.log(e.type, performance.now());
          let state;
          if (!this.state) {
            const storedState = this._getState();
            if (storedState)
              state = Tools.deepFreeze(Object.assign({}, this.state, storedState));
            else
              state = Tools.deepFreeze(Object.assign({}, this.state, this.initialState));
          }
          this.set('state', state);
          this._stateSnapshot(state, e.type);
        });

        // just for logging
        listen('app-data-loaded', (e) => {
          console.log(e.type, performance.now());
        });

        listen('state-user-in', (e) => {
          console.log(e.type, performance.now());
          const user = e.detail;
          const state = Tools.deepFreeze(Tools.setIn(this.state, ['user'], user));
          this.set('state', state);
          this._stateSnapshot(state, e.type);
        });

        listen('state-user-out', (e) => {
          console.log(e.type, performance.now());
          const state = Tools.deepFreeze(Tools.setIn(this.state, ['user'], null));
          this.set('state', state);
          this._stateSnapshot(state, e.type);
        });

        listen('state-server-albums', (e) => {
          console.log(e.type, performance.now());
          const albums = e.detail;
          const state = Tools.deepFreeze(Tools.setIn(this.state, ['albums'], albums));
          this.set('state', state);
          this._stateSnapshot(state, e.type);
        });

        listen('state-server-settings', (e) => {
          console.log(e.type, performance.now());
          const settings = e.detail;
          const state = Tools.deepFreeze(Tools.setIn(this.state, ['settings'], settings));
          this.set('state', state);
          this._stateSnapshot(state, e.type);
        });

        listen('state-change-settings', (e) => {
          console.log(e.type, performance.now());
          const prop = e.detail;
          const state = Tools.deepFreeze(Tools.setIn(this.state, ['settings', prop.key], prop.value));
          this.set('state', state);
          this._stateSnapshot(state, e.type);
        });
      }

      _storeState(state) {
        localStorage.setItem('state', JSON.stringify(state));
      }

      _getState() {
        return JSON.parse(localStorage.getItem('state'));
      }

      _stateSnapshot(snapshot, action) {
        this.history.newSnapshot({
          action: action,
          snapshot: snapshot,
          timestamp: performance.now()
        });
      }

      fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {
          composed: true,
          bubbles: true,
          detail: detail
        }))
      }
    }
    customElements.define(AppState.is, AppState);
  </script>
</dom-module>