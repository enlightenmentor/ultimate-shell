<link rel="import" href="fire-data.html">
<link rel="import" href="fire-auth.html">

<dom-module id="app-data">
  <template>

    <fire-data id="albums" path="common/albums"></fire-data>
    <fire-data id="settings"></fire-data>
    <fire-auth id="auth"></fire-auth>

  </template>
  <script>
    class AppData extends Polymer.Element {
      static get is() {
        return "app-data";
      }

      static get properties() {
        return {
          userSettings: {
            type: Object,
            observer: '_writeUserSettings'
          },
          user: Object
        }
      }

      constructor() {
        super();
        window.addEventListener('app-connected', (e) => this._appConnected());
        window.addEventListener('online', (e) => this._appOnline());
        window.addEventListener('offline', (e) => this._appOffline());
      }

      _appConnected() {
        // reading server albums (static data that everybody can see)
        this.$.albums.read().then((albums) => {
          this.fire('state-action', {
            type: 'SERVER_ALBUMS',
            payload: albums
          })
        });
        // listening on changes of albums
        this.$.albums.listen((data) => {
          this.fire('state-action', {
            type: 'SERVER_ALBUMS',
            payload: data
          })
        });

        // cheching if user was signed in last session
        this.$.auth.checkUser().then((user) => {
          if (user) {
            user = this._makeUser(user);
            this.fire("state-action", {
              type: "USER_IN",
              payload: user
            });
            this._readUserSettings(user);
          } else {
            this.fire("state-action", {
              type: "USER_OUT"
            });
          }
        });
      }

      _appOnline() {
        this._writeUserSettings(this.userSettings);
        if (this.user) {
          this._readUserSettings(this.user);
        }
      }

      signIn() {
        this.$.auth.signIn()
          .then((result) => {
            const user = this._makeUser(result.user);
            this.fire("state-action", {
              type: "USER_IN",
              payload: user
            });
            this._readUserSettings(user);
          })
          .catch((err) => {
            throw new Error(err);
          });
      }

      signOut() {
        // if user is out disconnecting user settings fire-data
        this.$.settings.path = undefined;
        this.$.settings.stopListen();
        this.$.auth.signOut()
          .then(() => {
            this.fire("state-action", {
              type: "USER_OUT"
            });
          })
          .catch((err) => {
            throw new Error(err);
          });
      }

      _makeUser(user) {
        return {
          name: user.displayName,
          email: user.email,
          photo: user.photoURL,
          uid: user.uid
        };
      }

      _readUserSettings(user) {
        // if user is in reading server user settings
        this.$.settings.read(`users/${user.uid}/settings`)
          .then((settings) => {
            if (settings) {
              this.fire('state-action', {
                type: 'SERVER_SETTINGS',
                payload: settings
              })
            }
          });
        // listening on changes for user settings (relevant for data that can be changed not only by this user)
        this.$.settings.listen((data) => {
          if (data) {
            this.fire('state-action', {
              type: 'SERVER_SETTINGS',
              payload: data
            })
          }
        });
      }

      _writeUserSettings(settings) {
        // writing settings to server if signed in user had change them on client side
        if (navigator.onLine && this.user) {
          this.$.settings.write(settings);
        }
      }

      fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {
          composed: true,
          bubbles: true,
          detail: detail
        }))
      }
    }
    customElements.define(AppData.is, AppData);
  </script>
</dom-module>