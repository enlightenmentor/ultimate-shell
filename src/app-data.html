<link rel="import" href="fire-data.html">
<link rel="import" href="idb-data.html">

<dom-module id="app-data">
  <template>

    <fire-data id="serverAlbums" path="common/albums"></fire-data>
    <idb-data id="mirrorAlbums" key="albums"></idb-data>
    <fire-data id="serverSettings"><fire-data>
    <idb-data id="mirrorSettings" key="settings"></idb-data>

  </template>
  <script>
    class AppData extends Polymer.Element {
      static get is() {
        return "app-data";
      }

      static get properties() {
        return {
          state: Object,
          mergedState: {
            type: Object,
            value: () => ({})
          }
        }
      }

      static get observers() {
        return [
          "_writeSettings(state.settings.*)",
          "_writeAlbums(state.albums)"
        ]
      }

      constructor() {
        super();

        window.addEventListener("app-load", async (e) => {
          console.log(`firstLoad: ${e.detail.firstLoad}, online: ${navigator.onLine}`);

          let mSettings = await this.$.mirrorSettings.read();
          this._mergeState(mSettings, 'settings');
          let mAlbums = await this.$.mirrorAlbums.read();
          this._mergeState(mAlbums, 'albums');
          let sAlbums = await this.$.serverAlbums.read();
          this._mergeState(sAlbums, 'albums');
        });

        window.addEventListener("online", (e) => {
          if (this.state.user && this.state.user.uid)
            this.$.serverSettings.write(this.state.settings);
        });

        window.addEventListener("offline", (e) => {

        });

        this._serverSettingsCallback = (e) => this._mergeState(e.detail, 'settings');
      }

      // called from outside
      async userIn(user) {
        this.$.serverSettings.path = `users/${user.uid}/settings`;
        let sSettings = await this.$.serverSettings.read();
        this._mergeState(sSettings, 'settings');
        this.$.serverSettings.addEventListener('new-firedata', this._serverSettingsCallback);
      }

      // called from outside
      userOut() {
        this.$.serverSettings.path = undefined;
        this.$.serverSettings.removeEventListener('new-firedata', this._serverSettingsCallback);
      }

      _writeSettings() {
        this.$.mirrorSettings.write(this.state.settings);
        if (this.state.user && this.state.user.uid && this.state.online)
          this.$.serverSettings.write(this.state.settings);
      }

      _writeAlbums() {
        this.$.mirrorAlbums.write(this.state.albums);
      }

      _mergeState(data, path) {
        console.log('merge state', window.performance.now());
        if (data && path)
          this.set(`mergedState.${path}`, data);
        this.fire("update-state", this.mergedState);
      }

      fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {
          composed: true,
          bubbles: true,
          detail: detail
        }))
      }
    }
    customElements.define(AppData.is, AppData);
  </script>
</dom-module>