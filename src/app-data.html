<link rel="import" href="fire-data.html">
<link rel="import" href="fire-auth.html">

<dom-module id="app-data">
  <template>

    <fire-data id="albums" path="common/albums"></fire-data>
    <fire-data id="settings"></fire-data>
    <fire-auth id="auth"></fire-auth>

  </template>
  <script>
    class AppData extends Polymer.Element {
      static get is() {
        return "app-data";
      }

      static get properties() {
        return {
          userSettings: {
            type: Object,
            observer: '_writeUserSettings'
          },
          user: Object
        }
      }

      constructor() {
        super();
        window.addEventListener('app-connected', (e) => this._appConnected());
        window.addEventListener('online', (e) => this._appOnline());
        window.addEventListener('offline', (e) => this._appOffline());
      }

      async _appConnected() {
        // reading server albums (static data that everybody can see)
        const albums = await this.$.albums.read();
        this.fire('state-action', {
          type: 'SERVER_ALBUMS',
          payload: albums
        })
        // listening on changes of albums
        this.$.albums.listen((data) => {
          this.fire('state-action', {
            type: 'SERVER_ALBUMS',
            payload: data
          })
        });

        // cheching if user was signed in last session
        let user = await this.$.auth.checkUser();
        if (user) {
          user = this._makeUser(user);
          this.fire("state-action", {
            type: "USER_IN",
            payload: user
          });
          this._readUserSettings(user);
        } else {
          this.fire("state-action", {
            type: "USER_OUT"
          });
        }
      }

      _appOnline() {
        this.$.albums.activate();
        this.$.settings.activate();
        this._writeUserSettings(this.userSettings);
        if (this.user) {
          this._readUserSettings(this.user);
        }
      }

      _appOffline() {
        this.$.albums.deactivate();
        this.$.settings.deactivate();
      }

      async signIn() {
        try {
          const result = await this.$.auth.signIn();
          const user = this._makeUser(result.user);
          this.fire("state-action", {
            type: "USER_IN",
            payload: user
          });
          this._readUserSettings(user);
        } catch(err) {
          throw new Error(err);
        }
      }

      async signOut() {
        // if user is out disconnecting user settings fire-data
        this.$.settings.deactivate();
        this.$.settings.stopListen();
        try {
          await this.$.auth.signOut();
          this.fire("state-action", {
            type: "USER_OUT"
          });
        } catch(err) {
          throw new Error(err);
        }
      }

      _makeUser(user) {
        return {
          name: user.displayName,
          email: user.email,
          photo: user.photoURL,
          uid: user.uid
        }
      }

      _readUserSettings(user) {
        // if user is in reading server user settings
        this.$.settings.setPath(`users/${user.uid}/settings`);
        this.$.settings.read()
          .then((settings) => {
            if (settings) {
              this.fire('state-action', {
                type: 'SERVER_SETTINGS',
                payload: settings
              })
            }
          });
        // listening on changes for user settings (relevant for data that can be changed not only by this user)
        this.$.settings.listen((data) => {
          if (data) {
            this.fire('state-action', {
              type: 'SERVER_SETTINGS',
              payload: data
            })
          }
        });
      }

      _writeUserSettings(settings) {
        // writing settings to server if signed in user had change them on client side
        if (navigator.onLine && this.user) {
          this.$.settings.write(settings);
        }
      }

      fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {
          composed: true,
          bubbles: true,
          detail: detail
        }))
      }
    }
    customElements.define(AppData.is, AppData);
  </script>
</dom-module>