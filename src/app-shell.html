<link rel="import" href="../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html" async>
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<script src="https://www.gstatic.com/firebasejs/3.9.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/3.9.0/firebase-auth.js"></script>

<link rel="import" href="firebase-auth.html">
<link rel="import" href="app-router.html">
<link rel="import" href="app-toolbar.html">
<link rel="import" href="app-search.html">
<link rel="import" href="app-drawer.html">
<link rel="import" href="app-content.html">
<link rel="import" href="app-snackbar.html" async>
<link rel="import" href="pages/page-home.html">

<link rel="import" href="css/app-theme.html" async>
<link rel="import" href="css/css-reset.html" async>
<link rel="import" href="css/paper-typography.html" async>

<dom-module id="app-shell">
  <template>
    <style include="app-theme css-reset paper-typography">
      :host {
        display: block;
      }
      app-toolbar {
        background-color: var(--primary-color);
      }
      paper-icon-button[icon=menu] {
        flex-shrink: 0;
        color: white;
      }
      app-drawer[persistent] #drawerHeader {
        display: none;
      }
      #drawerHeader {
        display: flex;
        box-sizing: border-box;
        height: 140px;
        align-items: flex-end;
        justify-content: flex-end;
        padding: 12px 16px;
        background: linear-gradient(to right bottom, var(--light-primary-color), var(--dark-primary-color));
        color: white;
        pointer-events: none;

        @apply --paper-font-headline;
      }
      #anonymPhoto {
        margin-left: 16px;
        padding: 6px;
        color: white;
      }
      #userPhoto {
        margin-left: 20px;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-size: cover;
        cursor: pointer;
      }
      #drawerMenu {
        flex: 1;
        position: relative;
      }
      #drawerMenu iron-selector {
        display: flex;
        box-sizing: border-box;
        height: 100%;
        flex-direction: column;
        padding: 12px 0;
      }
      #drawerMenu a {
        display: flex;
        box-sizing: border-box;
        position: relative;
        align-items: center;
        padding: 14px 0 14px 16px;
        @apply --paper-font-body1;
      }
      #drawerMenu a:hover {
        background-color: #fafafa;
      }
      #drawerMenu a.iron-selected {
        color: var(--dark-primary-color);
        font-weight: 600;
        background-color: #f5f5f5;
      }
      #drawerMenu a.iron-selected paper-ripple {
        opacity: 0;
        transition: opacity 0s 0.3s;
      }
      #drawerMenu a iron-icon {
        margin-right: 12px;
      }
      #drawerMenu div#separator {
        display: flex;
        margin: 12px 0;
        flex: 1;
        border-bottom: 1px solid #e0e0e0;
      }
    </style>

    <firebase-auth id="auth"></firebase-auth>

    <app-router on-route-changed="_getRoute"></app-router>

    <iron-media-query query="(min-width: 600px)" query-matches="{{queryMin600}}"></iron-media-query>
    <iron-media-query query="(max-width: 900px)" query-matches="{{queryMax900}}"></iron-media-query>

    <app-toolbar persistent="[[queryMin600]]" title="[[page]]">
      <paper-icon-button slot="menu" icon="menu" on-tap="_toggleDrawer"></paper-icon-button>
      <app-search slot="search" persistent="[[queryMin600]]" closed$="[[!queryMin600]]"></app-search>
      <paper-icon-button id="anonymPhoto" icon="social:person" hidden$="[[user]]" on-tap="_signIn"></paper-icon-button>
      <div id="userPhoto" style="background-image: url([[user.photo]])" hidden$="[[!user]]" on-tap="_signOut"></div>
    </app-toolbar>

    <app-drawer id="drawer" opened="[[!queryMax900]]" persistent="[[queryMin600]]">
      <div id="drawerHeader">
        Best App Shell
      </div>
      <div id="drawerMenu">
        <iron-selector selected="[[page]]" attr-for-selected="page">
          <a href="/home" page="home" on-tap="_closeMobileDrawer">
            <paper-ripple></paper-ripple>
            <span>Home</span>
          </a>
          <a href="/one" page="one" on-tap="_closeMobileDrawer">
            <paper-ripple></paper-ripple>
            <span>Page One</span>
          </a>
          <a href="/two" page="two" on-tap="_closeMobileDrawer">
            <paper-ripple></paper-ripple>
            <span>Page Two</span>
          </a>
          <div id="separator"></div>
          <a href="/settings" page="settings" on-tap="_closeMobileDrawer">
            <paper-ripple></paper-ripple>
            <iron-icon icon="settings"></iron-icon>
            <span>Settings</span>
          </a>
        </iron-selector>
      </div>
    </app-drawer>

    <app-content id="content" page="[[page]]" persistent="[[!queryMin600]]" squeezed="[[!queryMax900]]">
      <page-home page="home" user="[[user]]"></page-home>
      <page-one page="one"></page-one>
      <page-two page="two"></page-two>
      <page-404 page="404"></page-404>
      <page-settings page="settings"></page-settings>
    </app-content>

    <app-snackbar id="snackbar"></app-snackbar>

  </template>

  <script>

    // google-analytics

    firebase.initializeApp({
      apiKey: "AIzaSyAdERpJppFRDlFKM7q0AHwA2phHKDQvx7w",
      authDomain: "summer-on-firebase.firebaseapp.com",
      databaseURL: "https://summer-on-firebase.firebaseio.com",
      projectId: "summer-on-firebase",
      storageBucket: "summer-on-firebase.appspot.com",
      messagingSenderId: "90680327967"
    });

    class AppShell extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() {
        return "app-shell";
      }

      static get properties() {
        return {
          page: {
            type: String,
            reflectToAttribute: true
          },
          user: {
            type: Object,
            value: null
          }
        }
      }

      constructor() {
        super();
        window.addEventListener("online", (e) => this._showSnackbar("The device is online"));
        window.addEventListener("offline", (e) => this._showSnackbar("The device is offline"));
        this.addEventListener("show-snackbar", (e) => this._showSnackbar(e.detail));
        this.addEventListener("user-changed", (e) => this._handleUser(e.detail));
        this.addEventListener("dialog-submitted", (e) => console.log("Dialog result", e.detail));
      }

      connectedCallback() {
        super.connectedCallback();
        this.removeAttribute('unresolved');
      }

      _getRoute(e) {
        if (e.detail.segments) {
          this.page = e.detail.segments[0];
        } else {
          history.pushState({}, null, "/home");
          this.fire("location-changed");
        }
      }

      _signIn() {
        this.$.auth.signIn();
      }

      _signOut() {
        this.$.auth.signOut();
      }

      _handleUser(user) {
        if (user) {
          this.set("user", {
            name: user.displayName,
            email: user.email,
            photo: user.photoURL,
            uid: user.uid
          });
        } else {
          this.set("user", user);
        }
      }

      _toggleDrawer() {
        this.$.drawer.toggle();
        if (this.queryMin600)
          this.$.content.squeezed = this.$.drawer.opened;
      }

      _closeMobileDrawer() {
        if (!this.queryMin600)
          this.$.drawer.close();
      }

      _showSnackbar(text) {
        this.$.snackbar.show(text);
      }

      fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {
          composed: true,
          bubbles: true,
          detail: detail
        }))
      }
    }
    customElements.define(AppShell.is, AppShell);
  </script>
</dom-module>